#!/bin/bash
. $(dirname $(readlink -f $0))/virt-lib

HOST=$1

if ! gethost $HOST; then
	echo "Unknown host: $HOST"
	exit 2
fi

case ${HOSTTYPE^^} in
	FREEBSD)
    INSTALLPKG="pkg install rsync autotools bison flex readline gmake"
		FSTAB="192.168.192.1:/var/lib/virt/nfs		/mnt/nfs	nfs	rw	0	0"
    DHCPFIX="echo 'request broadcast-address, domain-name, domain-name-servers, domain-search, host-name, routers;' >> /etc/dhclient.conf"
    ;;
	OPENBSD) ;&
	NETBSD)
		FSTAB="192.168.192.1:/var/lib/virt/nfs		/mnt/nfs	nfs	rw	0	0"
		;;
	LINUX)
		FSTAB="192.168.192.1:/var/lib/virt/nfs		/mnt/nfs	nfs	defaults,intr,_netdev	0	0"
		;;
	*)
		echo "Unknown type of host: $TYPE"
		exit 2
		;;
esac

AUTH=`mktemp`

cat >$AUTH <<EOF
mkdir -p /root/.ssh
cat >/root/.ssh/authorized_keys <<EOC
EOF

cat /home/birdlab/.ssh/authorized_keys >> $AUTH
cat /root/.ssh/virt-rsa.pub >>$AUTH

echo EOC >>$AUTH

ssh root@$HOSTIP4 bash <$AUTH


SCRIPT=`mktemp`

cat >$SCRIPT <<EOF

if [ ! -x /bin/bash ]; then
	ln -s \$(command -v bash) /bin/bash
fi

rm -f /etc/udev/rules.d/70-persistent-net.rules

if egrep -q '/mnt/nfs[[:space:]]+nfs[[:space:]]+' /etc/fstab; then
	( egrep -v '/mnt/nfs[[:space:]]+nfs[[:space:]]+' /etc/fstab ; echo "$FSTAB") > /etc/fstab.new
	cp /etc/fstab.new /etc/fstab
	mkdir -p /mnt/nfs
	mount -o remount /mnt/nfs
else
	echo "$FSTAB" >> /etc/fstab
	mkdir -p /mnt/nfs
	mount /mnt/nfs
fi

$DHCPFIX

cat >/etc/rc.local <<EOC
#!/bin/bash
until [ -x /mnt/nfs/rc.local ]; do
	sleep 1
done

/mnt/nfs/rc.local > /tmp/rc-local-log 2>/tmp/rc-local-err
EOC
chmod +x /etc/rc.local

$INSTALLPKG
EOF

ssh root@$HOSTIP4 bash <$SCRIPT

rm $SCRIPT
rm $AUTH
